<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–®–ø–∏–æ–Ω: Dota 2</title>
  <style>
    :root {
      --bg-color: #f9f9f9;
      --text-color: #000;
      --card-bg: #fff;
      --input-bg: #fff;
      --btn-bg: #e0e0e0;
      --btn-hover: #d0d0d0;
      --hero-bg: #e3f2fd;
      --hero-hover: #bbdefb;
      --highlight-bg: #fff9c4;
      --highlight-border: #ffc107;
      --error-color: #f44336;
      --success-color: #4caf50;
      --accent-color: #1976d2;
    }

    [data-theme="dark"] {
      --bg-color: #121212;
      --text-color: #fff;
      --card-bg: #1e1e1e;
      --input-bg: #2c2c2c;
      --btn-bg: #333;
      --btn-hover: #444;
      --hero-bg: #2c3e50;
      --hero-hover: #34495e;
      --highlight-bg: #4a3c0a;
      --highlight-border: #d4af37;
      --error-color: #ff6b6b;
      --success-color: #6bff7e;
      --accent-color: #64b5f6;
    }

    [data-theme="pink"] {
      --bg-color: #ffeef2;
      --text-color: #5a2a45;
      --card-bg: #ffd6e0;
      --input-bg: #ffebf0;
      --btn-bg: #ff9ec4;
      --btn-hover: #ff7fb8;
      --hero-bg: #ffc4d6;
      --hero-hover: #ff9ec4;
      --highlight-bg: #fff0f5;
      --highlight-border: #ff69b4;
      --error-color: #d32f2f;
      --success-color: #388e3c;
      --accent-color: #ad1457;
    }

    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 15px;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
      margin: 0;
    }

    input, button {
      padding: 8px;
      margin: 5px;
      font-size: 16px;
      border-radius: 4px;
      background-color: var(--input-bg);
      color: var(--text-color);
      border: 1px solid var(--btn-bg);
    }

    #themeSelector {
      position: absolute;
      top: 10px;
      right: 10px;
      display: inline-block;
    }

    #themeToggleBtn {
      padding: 6px 12px;
      font-size: 18px;
      border-radius: 6px;
      cursor: pointer;
      background: var(--btn-bg);
      border: 1px solid #777;
    }

    #themeMenu {
      display: none;
      position: absolute;
      top: 40px;
      right: 0;
      background: var(--card-bg);
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    #themeMenu button {
      display: block;
      width: 100%;
      padding: 8px;
      background: none;
      border: none;
      text-align: left;
      cursor: pointer;
      color: var(--text-color);
    }

    #themeMenu button:hover {
      background: var(--btn-hover);
    }

    #lobby, #game {
      margin-top: 20px;
    }

    #game {
      display: none;
    }

    #role {
      font-size: 24px;
      color: var(--error-color);
      margin: 20px 0;
      font-weight: bold;
    }

    #heroGrid {
      display: none;
      margin: 20px auto;
      max-width: 800px;
      text-align: left;
    }

    .hero-btn {
      display: inline-block;
      margin: 4px;
      padding: 6px 10px;
      background: var(--hero-bg);
      border: 1px solid var(--hero-hover);
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      min-width: 100px;
      color: var(--text-color);
    }

    .hero-btn:hover {
      background: var(--hero-hover);
    }

    .hero-btn.incorrect {
      text-decoration: line-through;
      color: var(--error-color);
      pointer-events: none;
    }

    .hero-btn.highlight {
      background-color: var(--highlight-bg);
      border: 2px solid var(--highlight-border);
      box-shadow: 0 0 5px rgba(255, 193, 7, 0.6);
    }

    #result {
      font-size: 20px;
      color: var(--accent-color);
      margin: 20px 0;
      font-weight: bold;
    }

    .player-btn {
      display: inline-block;
      margin: 5px;
      padding: 8px 12px;
      background: var(--btn-bg);
      border: 1px solid #555;
      border-radius: 6px;
      cursor: pointer;
      min-width: 100px;
      color: var(--text-color);
    }

    .player-btn:hover {
      background: var(--btn-hover);
    }

    .votes {
      font-size: 14px;
      color: #888;
      margin-top: 4px;
    }

    .attr-section {
      margin-bottom: 20px;
    }

    .attr-title {
      font-size: 18px;
      margin: 10px 0 8px;
      color: var(--text-color);
      text-align: left;
    }
  </style>
</head>
<body>
  <div id="themeSelector">
    <button id="themeToggleBtn" onclick="toggleThemeMenu()">üé®</button>
    <div id="themeMenu">
      <button onclick="setTheme('light')">–°–≤–µ—Ç–ª–∞—è</button>
      <button onclick="setTheme('dark')">–¢—ë–º–Ω–∞—è</button>
      <button onclick="setTheme('pink')">–†–æ–∑–æ–≤–∞—è üíñ</button>
    </div>
  </div>

  <h1>üïµÔ∏è‚Äç‚ôÇÔ∏è –®–ø–∏–æ–Ω: Dota 2</h1>

  <div id="lobby">
    <p><input type="text" id="playerName" placeholder="–í–∞—à–µ –∏–º—è" maxlength="20"></p>
    <button onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    <p>‚Äî –ò–õ–ò ‚Äî</p>
    <p><input type="text" id="joinRoomId" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (–ª–∞—Ç–∏–Ω–∏—Ü–∞)" maxlength="20"></p>
    <button onclick="joinRoom()">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
  </div>

  <div id="game">
    <h2>–ö–æ–º–Ω–∞—Ç–∞: <span id="roomName"></span></h2>
    <div id="players">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</div>
    
    <div id="heroGrid"></div>

    <div id="voteSection" style="display:none; margin:20px 0;">
      <p><strong>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ:</strong></p>
      <div id="playerButtons"></div>
    </div>
    
    <button id="startBtn" onclick="startGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É (—Ç–æ–ª—å–∫–æ –≤–µ–¥—É—â–µ–º—É)</button>
    <div id="role"></div>
    <div id="result"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io({
      reconnection: true,
      reconnectionAttempts: Infinity,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      timeout: 20000
    });
    
    let currentRoom = '';
    let myId = '';
    let players = [];
    let isSpy = false;
    let gameEnded = false;
    let receivedHeroes = null;

    // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ï–ú–û–ô ===
    function setTheme(theme) {
      localStorage.setItem('theme', theme);
      if (theme === 'light') {
        document.documentElement.removeAttribute('data-theme');
        document.getElementById('themeToggleBtn').innerText = 'üé®';
      } else {
        document.documentElement.setAttribute('data-theme', theme);
        if (theme === 'dark') document.getElementById('themeToggleBtn').innerText = 'üåô';
        if (theme === 'pink') document.getElementById('themeToggleBtn').innerText = 'üíñ';
      }
      hideThemeMenu();
    }

    function toggleThemeMenu() {
      const menu = document.getElementById('themeMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    function hideThemeMenu() {
      document.getElementById('themeMenu').style.display = 'none';
    }

    // –ó–∞–∫—Ä—ã–≤–∞—Ç—å –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', (e) => {
      const selector = document.getElementById('themeSelector');
      if (!selector.contains(e.target)) {
        hideThemeMenu();
      }
    });

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–º—ã
    const savedTheme = localStorage.getItem('theme') || 'light';
    setTheme(savedTheme);

    // === –û–°–¢–ê–õ–¨–ù–û–ô –ö–û–î ===
    socket.on('connect_error', () => {
      setTimeout(() => {
        socket.connect();
      }, 3000);
    });

    function generateRoomCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function createRoom() {
      const name = document.getElementById('playerName').value.trim();
      if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
      enterRoom(generateRoomCode(), name);
    }

    function joinRoom() {
      const name = document.getElementById('playerName').value.trim();
      const roomId = document.getElementById('joinRoomId').value.trim().toUpperCase();
      if (!name || !roomId) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã!');
      enterRoom(roomId, name);
    }

    function enterRoom(roomId, name) {
      currentRoom = roomId;
      socket.emit('joinRoom', { roomId, playerName: name });
      document.getElementById('roomName').innerText = roomId;
      document.getElementById('lobby').style.display = 'none';
      document.getElementById('game').style.display = 'block';
      resetUI();
    }

    function resetUI() {
      gameEnded = false;
      document.getElementById('result').innerHTML = '';
      document.getElementById('heroGrid').style.display = 'none';
      document.getElementById('voteSection').style.display = 'none';
      document.getElementById('startBtn').style.display = 'inline-block';
      isSpy = false;
      receivedHeroes = null;
    }

    socket.on('updatePlayers', (updatedPlayers) => {
      players = updatedPlayers;
      const names = players.map(p => p.name).join(', ');
      document.getElementById('players').innerHTML = `<strong>–ò–≥—Ä–æ–∫–∏ (${players.length}):</strong> ${names}`;
    });

    socket.on('yourRole', (data) => {
      isSpy = false;
      let attrLabel = '';
      switch(data.attribute) {
        case 'strength': attrLabel = '–°–∏–ª–∞ üí™'; break;
        case 'agility': attrLabel = '–õ–æ–≤–∫–æ—Å—Ç—å ‚ö°'; break;
        case 'intelligence': attrLabel = '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç üîÆ'; break;
        case 'universal': attrLabel = '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π üåê'; break;
        default: attrLabel = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      }
      document.getElementById('role').innerHTML = 
        `–í–∞—à–∞ —Ä–æ–ª—å: <strong>${data.role}</strong> (${attrLabel})`;
      document.getElementById('voteSection').style.display = 'block';
      document.getElementById('startBtn').style.display = 'none';
      renderHeroGrid(data.role, false);
      renderPlayerButtons({});
    });

    socket.on('chooseSpyHero', (data) => {
      isSpy = true;
      receivedHeroes = data.heroesByAttribute;
      document.getElementById('role').innerText = '–í—ã ‚Äî –®–ü–ò–û–ù! –£–≥–∞–¥–∞–π—Ç–µ –≥–µ—Ä–æ—è:';
      document.getElementById('voteSection').style.display = 'block';
      document.getElementById('startBtn').style.display = 'none';
      renderHeroGrid(null, true);
      renderPlayerButtons({});
    });

    socket.on('heroIncorrect', (data) => {
      const buttons = document.querySelectorAll('.hero-btn');
      buttons.forEach(btn => {
        if (btn.dataset.name === data.guess) {
          btn.classList.add('incorrect');
        }
      });
    });

    socket.on('updateVotes', (voteSummary) => {
      if (!gameEnded) {
        renderPlayerButtons(voteSummary);
      }
    });

    socket.on('gameEnd', (data) => {
      gameEnded = true;
      document.getElementById('result').innerHTML = `
        <div style="background:var(--card-bg); padding:15px; border-radius:8px; margin:15px auto; max-width:600px;">
          <strong>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</strong><br>
          ${data.message}
        </div>
        <button onclick="restartGame()">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
      `;
      document.getElementById('voteSection').style.display = 'none';
    });

    socket.on('gameRestarted', () => {
      resetUI();
    });

    function restartGame() {
      socket.emit('restartGame', { roomId: currentRoom });
    }

    function renderHeroGrid(correctHero, interactive) {
      const grid = document.getElementById('heroGrid');
      grid.innerHTML = '';

      if (interactive && receivedHeroes) {
        const searchBox = document.createElement('input');
        searchBox.id = 'spySearch';
        searchBox.placeholder = '–ü–æ–∏—Å–∫ –≥–µ—Ä–æ—è...';
        searchBox.style.marginBottom = '15px';
        searchBox.style.padding = '8px';
        searchBox.style.width = '100%';
        searchBox.style.maxWidth = '500px';
        searchBox.oninput = () => {
          const query = searchBox.value.trim().toLowerCase();
          document.querySelectorAll('.hero-btn').forEach(btn => {
            btn.classList.remove('highlight');
            if (query && btn.dataset.name.toLowerCase().includes(query)) {
              btn.classList.add('highlight');
            }
          });
        };
        grid.appendChild(searchBox);

        const attrNames = {
          strength: '–°–∏–ª–∞ üí™',
          agility: '–õ–æ–≤–∫–æ—Å—Ç—å ‚ö°',
          intelligence: '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç üîÆ',
          universal: '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ üåê'
        };

        for (const [attr, heroes] of Object.entries(receivedHeroes)) {
          const section = document.createElement('div');
          section.className = 'attr-section';

          const title = document.createElement('div');
          title.className = 'attr-title';
          title.textContent = attrNames[attr] || attr;
          section.appendChild(title);

          const container = document.createElement('div');
          container.style.display = 'flex';
          container.style.flexWrap = 'wrap';

          heroes.forEach(name => {
            const btn = document.createElement('div');
            btn.className = 'hero-btn';
            btn.innerText = name;
            btn.dataset.name = name;
            btn.onclick = () => {
              socket.emit('spyGuess', { roomId: currentRoom, guess: name });
            };
            container.appendChild(btn);
          });

          section.appendChild(container);
          grid.appendChild(section);
        }
      } else {
        const heroesList = [
          "Abaddon", "Alchemist", "Ancient Apparition", "Anti-Mage", "Arc Warden", "Axe",
          "Bane", "Batrider", "Beastmaster", "Bloodseeker", "Bounty Hunter", "Brewmaster",
          "Bristleback", "Broodmother", "Centaur Warrunner", "Chaos Knight", "Chen", "Clinkz",
          "Clockwerk", "Crystal Maiden", "Dark Seer", "Dark Willow", "Dawnbreaker", "Dazzle",
          "Disruptor", "Doom", "Dragon Knight", "Drow Ranger", "Earth Spirit", "Earthshaker",
          "Elder Titan", "Ember Spirit", "Enchantress", "Faceless Void", "Grimstroke", "Gyrocopter",
          "Hoodwink", "Huskar", "Invoker", "Io", "Jakiro", "Juggernaut", "Keeper of the Light",
          "Kunkka", "Legion Commander", "Leshrac", "Lich", "Lifestealer", "Lina", "Lion", "Lone Druid",
          "Luna", "Lycan", "Magnus", "Marci", "Mars", "Medusa", "Meepo", "Mirana", "Monkey King",
          "Morphling", "Muerta", "Naga Siren", "Nature's Prophet", "Necrophos", "Night Stalker",
          "Nyx Assassin", "Ogre Magi", "Omniknight", "Oracle", "Outworld Destroyer", "Pangolier",
          "Phantom Assassin", "Phantom Lancer", "Phoenix", "Primal Beast", "Puck", "Pudge",
          "Queen of Pain", "Razor", "Riki", "Rubick", "Sand King", "Shadow Demon", "Shadow Fiend",
          "Shadow Shaman", "Silencer", "Skywrath Mage", "Slardar", "Slark", "Snapfire", "Sniper",
          "Spectre", "Spirit Breaker", "Storm Spirit", "Sven", "Techies", "Templar Assassin",
          "Terrorblade", "Tidehunter", "Timbersaw", "Tinker", "Tiny", "Treant Protector",
          "Troll Warlord", "Tusk", "Underlord", "Undying", "Ursa", "Vengeful Spirit", "Venomancer",
          "Viper", "Visage", "Void Spirit", "Warlock", "Weaver", "Windranger", "Winter Wyvern",
          "Witch Doctor", "Wraith King", "Zeus"
        ];

        heroesList.forEach(name => {
          const btn = document.createElement('div');
          btn.className = 'hero-btn';
          btn.innerText = name;
          btn.dataset.name = name;
          if (correctHero && name === correctHero) {
            btn.style.border = '2px solid var(--success-color)';
          }
          grid.appendChild(btn);
        });
      }

      grid.style.display = 'block';
    }

    function renderPlayerButtons(voteSummary) {
      if (!players || players.length === 0) return;
      const container = document.getElementById('playerButtons');
      container.innerHTML = '';
      players.forEach(player => {
        if (player.id === myId) return;
        const btn = document.createElement('div');
        btn.className = 'player-btn';
        btn.innerText = player.name;
        btn.onclick = () => {
          socket.emit('vote', { roomId: currentRoom, targetId: player.id });
        };
        const votes = voteSummary[player.id] || 0;
        const voteEl = document.createElement('div');
        voteEl.className = 'votes';
        voteEl.innerText = `${votes} –≥–æ–ª–æ—Å(–æ–≤)`;
        btn.appendChild(voteEl);
        container.appendChild(btn);
      });
    }

    function startGame() {
      if (currentRoom) {
        socket.emit('startGame', currentRoom);
      }
    }
  </script>
</body>
</html>