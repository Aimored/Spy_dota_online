<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–®–ø–∏–æ–Ω: Dota 2</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 15px;
      background: #f9f9f9;
    }
    input, button {
      padding: 8px;
      margin: 5px;
      font-size: 16px;
      border-radius: 4px;
    }
    #lobby, #game {
      margin-top: 20px;
    }
    #game {
      display: none;
    }
    #role {
      font-size: 24px;
      color: #d32f2f;
      margin: 20px 0;
      font-weight: bold;
    }
    #heroGrid {
      display: none;
      margin: 20px auto;
      max-width: 800px;
      text-align: left;
    }
    .hero-btn {
      display: inline-block;
      margin: 4px;
      padding: 6px 10px;
      background: #e3f2fd;
      border: 1px solid #90caf9;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      min-width: 100px;
    }
    .hero-btn:hover {
      background: #bbdefb;
    }
    .hero-btn.incorrect {
      text-decoration: line-through;
      color: #f44336;
      pointer-events: none;
    }
    .hero-btn.highlight {
      background-color: #fff9c4;
      border: 2px solid #ffc107;
      box-shadow: 0 0 5px rgba(255, 193, 7, 0.6);
    }
    #result {
      font-size: 20px;
      color: #1976d2;
      margin: 20px 0;
      font-weight: bold;
    }
    .player-btn {
      display: inline-block;
      margin: 5px;
      padding: 8px 12px;
      background: #e0e0e0;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      min-width: 100px;
    }
    .player-btn:hover {
      background: #d0d0d0;
    }
    .votes {
      font-size: 14px;
      color: #555;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h1>üïµÔ∏è‚Äç‚ôÇÔ∏è –®–ø–∏–æ–Ω: Dota 2</h1>

  <div id="lobby">
    <p><input type="text" id="playerName" placeholder="–í–∞—à–µ –∏–º—è" maxlength="20"></p>
    <button onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    <p>‚Äî –ò–õ–ò ‚Äî</p>
    <p><input type="text" id="joinRoomId" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (–ª–∞—Ç–∏–Ω–∏—Ü–∞)" maxlength="20"></p>
    <button onclick="joinRoom()">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
  </div>

  <div id="game">
    <h2>–ö–æ–º–Ω–∞—Ç–∞: <span id="roomName"></span></h2>
    <div id="players">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</div>
    
    <div id="heroGrid"></div>

    <div id="voteSection" style="display:none; margin:20px 0;">
      <p><strong>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ:</strong></p>
      <div id="playerButtons"></div>
    </div>
    
    <button id="startBtn" onclick="startGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É (—Ç–æ–ª—å–∫–æ –≤–µ–¥—É—â–µ–º—É)</button>
    <div id="role"></div>
    <div id="result"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentRoom = '';
    let myId = '';
    let players = [];
    let isSpy = false;
    let gameEnded = false;

    socket.on('connect', () => { myId = socket.id; });

    function generateRoomCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function createRoom() {
      const name = document.getElementById('playerName').value.trim();
      if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
      enterRoom(generateRoomCode(), name);
    }

    function joinRoom() {
      const name = document.getElementById('playerName').value.trim();
      const roomId = document.getElementById('joinRoomId').value.trim().toUpperCase();
      if (!name || !roomId) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã!');
      enterRoom(roomId, name);
    }

    function enterRoom(roomId, name) {
      currentRoom = roomId;
      socket.emit('joinRoom', { roomId, playerName: name });
      document.getElementById('roomName').innerText = roomId;
      document.getElementById('lobby').style.display = 'none';
      document.getElementById('game').style.display = 'block';
      resetUI();
    }

    function resetUI() {
      gameEnded = false;
      document.getElementById('result').innerHTML = '';
      document.getElementById('heroGrid').style.display = 'none';
      document.getElementById('voteSection').style.display = 'none';
      document.getElementById('startBtn').style.display = 'inline-block';
      isSpy = false;
    }

    socket.on('updatePlayers', (updatedPlayers) => {
      players = updatedPlayers;
      const names = players.map(p => p.name).join(', ');
      document.getElementById('players').innerHTML = `<strong>–ò–≥—Ä–æ–∫–∏ (${players.length}):</strong> ${names}`;
    });

    socket.on('yourRole', (data) => {
      isSpy = false;
      document.getElementById('role').innerText = `–í–∞—à–∞ —Ä–æ–ª—å: ${data.role}`;
      document.getElementById('voteSection').style.display = 'block';
      document.getElementById('startBtn').style.display = 'none';
      renderHeroGrid(data.role, false);
      renderPlayerButtons({});
    });

    socket.on('chooseSpyHero', (data) => {
      isSpy = true;
      document.getElementById('role').innerText = '–í—ã ‚Äî –®–ü–ò–û–ù! –£–≥–∞–¥–∞–π—Ç–µ –≥–µ—Ä–æ—è:';
      renderHeroGrid(null, true);
    });

    socket.on('heroIncorrect', (data) => {
      const buttons = document.querySelectorAll('.hero-btn');
      buttons.forEach(btn => {
        if (btn.dataset.name === data.guess) {
          btn.classList.add('incorrect');
        }
      });
    });

    socket.on('updateVotes', (voteSummary) => {
      if (!gameEnded) {
        renderPlayerButtons(voteSummary);
      }
    });

    socket.on('gameEnd', (data) => {
      gameEnded = true;
      document.getElementById('result').innerHTML = `
        ${data.message}<br>
        <button onclick="restartGame()">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
      `;
      document.getElementById('voteSection').style.display = 'none';
      if (!isSpy) {
        renderHeroGrid(roomsData?.trueHero, false);
      }
    });

    socket.on('gameRestarted', () => {
      resetUI();
    });

    function restartGame() {
      socket.emit('restartGame', { roomId: currentRoom });
    }

    function renderHeroGrid(correctHero, interactive) {
      const grid = document.getElementById('heroGrid');
      grid.innerHTML = '';

      if (interactive) {
        const searchBox = document.createElement('input');
        searchBox.id = 'spySearch';
        searchBox.placeholder = '–ü–æ–∏—Å–∫ –≥–µ—Ä–æ—è...';
        searchBox.style.marginBottom = '10px';
        searchBox.style.padding = '6px';
        searchBox.style.width = '100%';
        searchBox.style.maxWidth = '400px';
        searchBox.oninput = () => {
          const query = searchBox.value.trim().toLowerCase();
          document.querySelectorAll('.hero-btn').forEach(btn => {
            btn.classList.remove('highlight');
            if (query && btn.dataset.name.toLowerCase().includes(query)) {
              btn.classList.add('highlight');
            }
          });
        };
        grid.appendChild(searchBox);
      }

      heroesList.forEach(name => {
        const btn = document.createElement('div');
        btn.className = 'hero-btn';
        btn.innerText = name;
        btn.dataset.name = name;

        if (interactive) {
          btn.onclick = () => {
            socket.emit('spyGuess', { roomId: currentRoom, guess: name });
          };
        } else {
          btn.style.opacity = '0.6';
          btn.style.cursor = 'default';
          btn.style.backgroundColor = '#f5f5f5';
          if (correctHero && name === correctHero) {
            btn.style.border = '2px solid #4caf50';
          }
        }

        grid.appendChild(btn);
      });

      grid.style.display = 'block';
    }

    function renderPlayerButtons(voteSummary) {
      if (!players || players.length === 0) return;
      const container = document.getElementById('playerButtons');
      container.innerHTML = '';
      players.forEach(player => {
        if (player.id === myId) return; // –Ω–µ–ª—å–∑—è –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –ø—Ä–æ—Ç–∏–≤ —Å–µ–±—è
        const btn = document.createElement('div');
        btn.className = 'player-btn';
        btn.innerText = player.name;
        btn.onclick = () => {
          socket.emit('vote', { roomId: currentRoom, targetId: player.id });
        };
        const votes = voteSummary[player.id] || 0;
        const voteEl = document.createElement('div');
        voteEl.className = 'votes';
        voteEl.innerText = `${votes} –≥–æ–ª–æ—Å(–æ–≤)`;
        btn.appendChild(voteEl);
        container.appendChild(btn);
      });
    }

    function startGame() {
      if (currentRoom) {
        socket.emit('startGame', currentRoom);
      }
    }

    const heroesList = [
      "Anti-Mage", "Axe", "Bane", "Bloodseeker", "Crystal Maiden", "Drow Ranger",
      "Earthshaker", "Juggernaut", "Mirana", "Morphling", "Shadow Fiend", "Phantom Lancer",
      "Puck", "Pudge", "Razor", "Sand King", "Storm Spirit", "Sven", "Tiny", "Vengeful Spirit",
      "Windranger", "Zeus", "Kunkka", "Lina", "Lion", "Necrophos", "Ogre Magi", "Riki", "Sniper",
      "Templar Assassin", "Viper", "Luna", "Dragon Knight", "Dazzle", "Clockwerk", "Leshrac",
      "Nature's Prophet", "Lifestealer", "Dark Seer", "Clinkz", "Omniknight", "Enchantress",
      "Huskar", "Night Stalker", "Broodmother", "Bounty Hunter", "Weaver", "Jakiro", "Batrider",
      "Chen", "Spectre", "Ancient Apparition", "Doom", "Ursa", "Spirit Breaker", "Gyrocopter",
      "Alchemist", "Invoker", "Silencer", "Outworld Destroyer", "Lycan", "Brewmaster",
      "Shadow Shaman", "Lone Druid", "Chaos Knight", "Meepo", "Treant Protector", "Undying",
      "Rubick", "Disruptor", "Nyx Assassin", "Naga Siren", "Keeper of the Light", "Io",
      "Visage", "Slark", "Medusa", "Troll Warlord", "Tusk", "Bristleback", "Skywrath Mage",
      "Abaddon", "Elder Titan", "Legion Commander", "Techies", "Ember Spirit", "Earth Spirit",
      "Abyssal Underlord", "Terrorblade", "Phoenix", "Oracle", "Winter Wyvern", "Arc Warden",
      "Monkey King", "Dark Willow", "Pangolier", "Grimstroke", "Hoodwink", "Void Spirit",
      "Snapfire", "Mars", "Dawnbreaker", "Marci", "Primal Beast", "Muerta"
    ];
  </script>
</body>
</html>